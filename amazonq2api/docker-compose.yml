# ============================================
# Amazon Q to API - Docker Compose 配置
# ============================================
# 
# 使用方法:
#   1. 复制 .env.example 为 .env 并填写配置
#   2. 运行: docker compose up -d
#   3. 查看日志: docker compose logs -f
#   4. 停止: docker compose down
# ============================================

services:
  # PostgreSQL 数据库
  postgres:
    image: postgres:16-alpine
    container_name: amazonq2api-postgres
    restart: unless-stopped
    
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-amazonq}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-amazonq_secret}
      - POSTGRES_DB=${POSTGRES_DB:-amazonq}
    
    volumes:
      - postgres-data:/var/lib/postgresql/data
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-amazonq} -d ${POSTGRES_DB:-amazonq}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    
    # 仅在内部网络暴露
    networks:
      - amazonq-network

  # Amazon Q API 服务
  amazonq2api:
    build:
      context: .
      dockerfile: Dockerfile
    image: amazonq2api:latest
    container_name: amazonq2api
    restart: unless-stopped
    
    # 依赖 PostgreSQL
    depends_on:
      postgres:
        condition: service_healthy
    
    # 端口映射
    ports:
      - "${PORT:-3000}:3000"
    
    # 环境变量（从 .env 文件加载）
    environment:
      # 通用配置
      - PORT=${PORT:-3000}
      - HEADLESS=${HEADLESS:-true}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      
      # 数据库配置
      - DATABASE_URL=postgresql://${POSTGRES_USER:-amazonq}:${POSTGRES_PASSWORD:-amazonq_secret}@postgres:5432/${POSTGRES_DB:-amazonq}?schema=public
      
      # API 认证
      - API_KEY=${API_KEY:-}
      
      # GPTMail 配置
      - GPTMAIL_API_KEY=${GPTMAIL_API_KEY}
      - GPTMAIL_BASE_URL=${GPTMAIL_BASE_URL:-https://mail.chatgpt.org.uk}
      - GPTMAIL_EMAIL_PREFIX=${GPTMAIL_EMAIL_PREFIX:-}
      - GPTMAIL_EMAIL_DOMAIN=${GPTMAIL_EMAIL_DOMAIN:-}
      
      # 代理配置
      - HTTP_PROXY=${HTTP_PROXY:-}
      - PROXY_LIST=${PROXY_LIST:-}
    
    networks:
      - amazonq-network
    
    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    # 资源限制
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    
    # 安全选项
    security_opt:
      - no-new-privileges:true
    
    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# 网络配置
networks:
  amazonq-network:
    name: amazonq-network
    driver: bridge

# 命名卷
volumes:
  postgres-data:
    name: amazonq2api-postgres-data
