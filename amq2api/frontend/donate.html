<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antigravity æŠ•å–‚ç«™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }

        .donate-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
            display: block;
            margin: 0 auto;
        }

        .donate-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 87, 108, 0.6);
        }

        .donate-button:active {
            transform: translateY(0);
        }

        .accounts-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .accounts-card h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .account-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
        }

        .account-item:hover {
            transform: translateX(5px);
        }

        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .account-label {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }

        .account-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .account-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1em;
            color: #333;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #c3e6cb;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .manual-input-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #667eea;
        }

        .manual-input-section h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1em;
        }

        .manual-input-section p {
            margin-bottom: 15px;
            color: #666;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.95em;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            white-space: nowrap;
        }

        .input-group button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .input-group button:active {
            transform: translateY(0);
        }

        .input-group button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ Antigravity æŠ•å–‚ç«™</h1>
            <p>åˆ†äº«ä½ çš„ Gemini è´¦å·ï¼Œè®©æ›´å¤šäººä½“éªŒ AI çš„é­…åŠ›</p>
        </div>

        <div class="stats-card">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">æ´»è·ƒè´¦å·</div>
                    <div class="stat-value" id="activeAccounts">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æ€»è´¦å·æ•°</div>
                    <div class="stat-value" id="totalAccounts">-</div>
                </div>
            </div>
            <div id="modelTotalsContainer" style="margin-top: 20px;"></div>
            <button class="donate-button" onclick="startDonation()">
                âœ¨ æŠ•å–‚æˆ‘çš„ Gemini è´¦å·
            </button>

            <!-- æ‰‹åŠ¨è¾“å…¥åŒºåŸŸ -->
            <div class="manual-input-section">
                <h3>ğŸ”— æ‰‹åŠ¨æäº¤æˆæƒé“¾æ¥</h3>
                <p>å¦‚æœå¼¹å‡ºçª—å£è¢«é˜»æ­¢æˆ–æˆæƒåå‡ºç°é”™è¯¯ï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨å¤åˆ¶æˆæƒå®Œæˆåçš„å®Œæ•´ URL å¹¶ç²˜è´´åˆ°ä¸‹æ–¹è¾“å…¥æ¡†æäº¤ã€‚</p>
                <p style="font-size: 0.85em; color: #999;">ç¤ºä¾‹: http://localhost:8383/oauth-callback-page?state=xxx&code=xxx&scope=xxx</p>
                <div class="input-group">
                    <input
                        type="text"
                        id="manualUrlInput"
                        placeholder="ç²˜è´´æˆæƒå®Œæˆåçš„å®Œæ•´ URL..."
                        autocomplete="off"
                    />
                    <button onclick="submitManualUrl()" id="submitManualBtn">æäº¤</button>
                </div>
            </div>
        </div>

        <div class="accounts-card">
            <h2>ğŸ“‹ è´¦å·åˆ—è¡¨</h2>
            <div id="accountsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åŠ è½½è´¦å·ä¿¡æ¯...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å¯åŠ¨æŠ•å–‚æµç¨‹ï¼ˆä½¿ç”¨å¼¹å‡ºçª—å£ï¼‰
        function startDonation() {
            // æ„å»º OAuth URL
            const clientId = '1071006060591-tmhssin2h21lcre235vtolojh4g403ep.apps.googleusercontent.com';
            const redirectUri = 'http://localhost:64312/oauth-callback';
            const scopes = [
                'https://www.googleapis.com/auth/cloud-platform',
                'https://www.googleapis.com/auth/userinfo.email',
                'https://www.googleapis.com/auth/userinfo.profile',
                'https://www.googleapis.com/auth/cclog',
                'https://www.googleapis.com/auth/experimentsandconfigs'
            ].join(' ');

            const state = generateState();
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                `client_id=${encodeURIComponent(clientId)}` +
                `&redirect_uri=${encodeURIComponent(redirectUri)}` +
                `&response_type=code` +
                `&scope=${encodeURIComponent(scopes)}` +
                `&access_type=offline` +
                `&prompt=consent` +
                `&state=${state}`;

            // æ‰“å¼€å¼¹å‡ºçª—å£
            const width = 600;
            const height = 700;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            const popup = window.open(
                authUrl,
                'OAuth Authorization',
                `width=${width},height=${height},left=${left},top=${top},toolbar=no,menubar=no,location=no,status=no`
            );

            if (!popup) {
                alert('å¼¹å‡ºçª—å£è¢«é˜»æ­¢ï¼Œè¯·å…è®¸å¼¹å‡ºçª—å£åé‡è¯•');
                return;
            }

            // ç›‘å¬æ¥è‡ªå¼¹å‡ºçª—å£çš„æ¶ˆæ¯
            window.addEventListener('message', handleOAuthMessage);
        }

        // å¤„ç† OAuth å›è°ƒæ¶ˆæ¯
        async function handleOAuthMessage(event) {
            // éªŒè¯æ¶ˆæ¯æ¥æº
            if (event.origin !== window.location.origin) {
                return;
            }

            const { type, code, error } = event.data;

            if (type === 'oauth-error') {
                const accountsList = document.getElementById('accountsList');
                accountsList.insertAdjacentHTML('afterbegin', `
                    <div class="error">
                        âŒ æˆæƒå¤±è´¥: ${escapeHtml(error)}
                    </div>
                `);
                // ç§»é™¤äº‹ä»¶å¬
                window.removeEventListener('message', handleOAuthMessage);
                return;
            }

            if (type === 'oauth-success' && code) {
                try {
                    // æäº¤ code åˆ°åç«¯
                    const response = await fetch('/api/gemini/oauth-callback', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ code })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'æäº¤å¤±è´¥');
                    }

                    // æˆåŠŸ
                    const accountsList = document.getElementById('accountsList');
                    accountsList.insertAdjacentHTML('afterbegin', `
                        <div class="success">
                            âœ“ è´¦å·æ·»åŠ æˆåŠŸï¼æ„Ÿè°¢ä½ çš„æŠ•å–‚ ğŸ‰
                        </div>
                    `);

                    // åˆ·æ–°è´¦å·åˆ—è¡¨
                    setTimeout(() => loadAccounts(), 1000);

                } catch (err) {
                    const accountsList = document.getElementById('accountsList');
                    accountsList.insertAdjacentHTML('afterbegin', `
                        <div class="error">
                            âŒ æ·»åŠ å¤±è´¥: ${escapeHtml(err.message)}
                        </div>
                    `);
                }

                // ç§»é™¤äº‹ä»¶ç›‘å¬
                window.removeEventListener('message', handleOAuthMessage);
            }
        }

        // ç”Ÿæˆéšæœº state
        function generateState() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        }

        // åŠ è½½è´¦å·åˆ—è¡¨
        async function loadAccounts() {
            try {
                const response = await fetch('/api/gemini/accounts');
                if (!response.ok) {
                    throw new Error('åŠ è½½å¤±è´¥');
                }

                const data = await response.json();
                displayAccounts(data);
            } catch (error) {
                document.getElementById('accountsList').innerHTML = `
                    <div class="error">
                        âŒ åŠ è½½è´¦å·åˆ—è¡¨å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºè´¦å·åˆ—è¡¨
        function displayAccounts(data) {
            const accountsList = document.getElementById('accountsList');

            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            document.getElementById('activeAccounts').textContent = data.activeCount || 0;
            document.getElementById('totalAccounts').textContent = data.totalCount || 0;

            // æ˜¾ç¤ºæ¯ä¸ªæ¨¡å‹çš„æ€»é…é¢
            const modelTotalsContainer = document.getElementById('modelTotalsContainer');
            const modelTotals = data.modelTotals || {};

            if (Object.keys(modelTotals).length > 0) {
                const modelTotalsHtml = Object.entries(modelTotals)
                    .map(([modelId, info]) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                            <span style="font-weight: 600; color: #333;">${escapeHtml(info.displayName || modelId)}</span>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span style="font-size: 0.9em; color: #666;">${info.accountCount} ä¸ªè´¦å·</span>
                                <span style="font-size: 1.3em; font-weight: bold; color: ${info.averagePercent > 50 ? '#28a745' : info.averagePercent > 20 ? '#ffc107' : '#dc3545'};">
                                    ${info.averagePercent}%
                                </span>
                            </div>
                        </div>
                    `).join('');

                modelTotalsContainer.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <h3 style="font-size: 1.1em; color: #333; margin-bottom: 15px;">ğŸ“Š æ¨¡å‹é…é¢ç»Ÿè®¡</h3>
                        ${modelTotalsHtml}
                    </div>
                `;
            } else {
                modelTotalsContainer.innerHTML = '';
            }

            // æ˜¾ç¤ºè´¦å·åˆ—è¡¨
            if (!data.accounts || data.accounts.length === 0) {
                accountsList.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                        </svg>
                        <h3>æš‚æ— è´¦å·</h3>
                        <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æŠ•å–‚ä½ çš„ç¬¬ä¸€ä¸ª Gemini è´¦å·å§ï¼</p>
                    </div>
                `;
                return;
            }

            accountsList.innerHTML = data.accounts.map(account => {
                const creditsInfo = account.creditsInfo || { models: {}, summary: {} };
                const models = creditsInfo.models || {};
                const summary = creditsInfo.summary || {};

                // ç”Ÿæˆæ¨¡å‹é…é¢åˆ—è¡¨
                const modelsHtml = Object.entries(models)
                    .filter(([_, info]) => info.recommended) // åªæ˜¾ç¤ºæ¨èæ¨¡å‹
                    .map(([modelId, info]) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <span style="font-size: 0.9em; color: #666;">${escapeHtml(info.displayName || modelId)}</span>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-weight: 500; color: ${info.remainingPercent > 50 ? '#28a745' : info.remainingPercent > 20 ? '#ffc107' : '#dc3545'};">
                                    ${info.remainingPercent}%
                                </span>
                                <span style="font-size: 0.85em; color: #999;">
                                    ${formatResetTime(info.resetTime)}
                                </span>
                            </div>
                        </div>
                    `).join('');

                return `
                    <div class="account-item">
                        <div class="account-header">
                            <span class="account-label">${escapeHtml(account.label || 'æœªå‘½åè´¦å·')}</span>
                            <span class="account-status ${account.enabled ? 'status-active' : 'status-inactive'}">
                                ${account.enabled ? 'âœ“ æ´»è·ƒ' : 'âœ— ç¦ç”¨'}
                            </span>
                        </div>
                        <div class="account-details">
                            <div class="detail-item">
                                <span class="detail-label">å¹³å‡é…é¢</span>
                                <span class="detail-value">${Math.round((summary.averageRemaining || 0) * 100)}%</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">æ¨¡å‹æ•°é‡</span>
                                <span class="detail-value">${summary.totalModels || 0}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">é¡¹ç›® ID</span>
                                <span class="detail-value">${escapeHtml(account.projectId || 'N/A')}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">æ·»åŠ æ—¶é—´</span>
                                <span class="detail-value">${formatDate(account.created_at)}</span>
                            </div>
                        </div>
                        ${modelsHtml ? `
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #f0f0f0;">
                                <div style="font-weight: 600; margin-bottom: 10px; color: #333;">æ¨èæ¨¡å‹é…é¢</div>
                                ${modelsHtml}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // æ ¼å¼åŒ–æ•°å­—
        function formatNumber(num) {
            return num.toLocaleString('zh-CN');
        }

        // æ ¼å¼åŒ–é‡ç½®æ—¶é—´
        function formatResetTime(resetTime) {
            if (!resetTime) return 'N/A';
            try {
                const date = new Date(resetTime);
                const now = new Date();
                const diff = date - now;

                if (diff < 0) return 'å·²é‡ç½®';

                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                if (days > 0) {
                    return `${days}å¤©${hours}æ—¶${minutes}åˆ†${seconds}ç§’`;
                } else if (hours > 0) {
                    return `${hours}æ—¶${minutes}åˆ†${seconds}ç§’`;
                } else if (minutes > 0) {
                    return `${minutes}åˆ†${seconds}ç§’`;
                } else {
                    return `${seconds}ç§’`;
                }
            } catch {
                return 'N/A';
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } catch {
                return 'N/A';
            }
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ‰‹åŠ¨æäº¤ URL
        async function submitManualUrl() {
            const input = document.getElementById('manualUrlInput');
            const submitBtn = document.getElementById('submitManualBtn');
            const url = input.value.trim();

            if (!url) {
                alert('è¯·è¾“å…¥æˆæƒå®Œæˆåçš„ URL');
                return;
            }

            try {
                // è§£æ URL æå– code å‚æ•°
                const urlObj = new URL(url);
                const code = urlObj.searchParams.get('code');

                if (!code) {
                    throw new Error('URL ä¸­æœªæ‰¾åˆ°æˆæƒç  (code å‚æ•°)');
                }

                // ç¦ç”¨æŒ‰é’®å’Œè¾“å…¥æ¡†
                submitBtn.disabled = true;
                submitBtn.textContent = 'æäº¤ä¸­...';
                input.disabled = true;

                // æäº¤ code åˆ°åç«¯
                const response = await fetch('/api/gemini/oauth-callback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'æäº¤å¤±è´¥');
                }

                // æˆåŠŸ
                const accountsList = document.getElementById('accountsList');
                accountsList.insertAdjacentHTML('afterbegin', `
                    <div class="success">
                        âœ“ è´¦å·æ·»åŠ æˆåŠŸï¼æ„Ÿè°¢ä½ çš„æŠ•å–‚ ğŸ‰
                    </div>
                `);

                // æ¸…ç©ºè¾“å…¥æ¡†
                input.value = '';

                // åˆ·æ–°è´¦å·åˆ—è¡¨
                setTimeout(() => loadAccounts(), 1000);

            } catch (err) {
                const accountsList = document.getElementById('accountsList');
                accountsList.insertAdjacentHTML('afterbegin', `
                    <div class="error">
                        âŒ ${escapeHtml(err.message)}
                    </div>
                `);
            } finally {
                // æ¢å¤æŒ‰é’®å’Œè¾“å…¥æ¡†
                submitBtn.disabled = false;
                submitBtn.textContent = 'æäº¤';
                input.disabled = false;
            }
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰å›è°ƒå‚æ•°
        function checkCallback() {
            const params = new URLSearchParams(window.location.search);
            const success = params.get('success');
            const error = params.get('error');

            if (success === 'true') {
                const accountsList = document.getElementById('accountsList');
                accountsList.insertAdjacentHTML('afterbegin', `
                    <div class="success">
                        âœ“ è´¦å·æ·»åŠ æˆåŠŸï¼æ„Ÿè°¢ä½ çš„æŠ•å–‚ ğŸ‰
                    </div>
                `);
                // æ¸…é™¤ URL å‚æ•°
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (error) {
                const accountsList = document.getElementById('accountsList');
                accountsList.insertAdjacentHTML('afterbegin', `
                    <div class="error">
                        âŒ æ·»åŠ å¤±è´¥: ${escapeHtml(decodeURIComponent(error))}
                    </div>
                `);
                // æ¸…é™¤ URL å‚æ•°
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        window.addEventListener('DOMContentLoaded', () => {
            checkCallback();
            loadAccounts();
            // æ¯ 30 ç§’åˆ·æ–°ä¸€æ¬¡
            setInterval(loadAccounts, 30000);
        });
    </script>
</body>
</html>